Dim con1(1 To 10, 1 To 4), photo1(1 To 10, 1 To 5), photo2(1 To 10, 1 To 5) As Double
For j = 1 To photopoints
         photo2(j, 1) = photo(j, 1)
         photo2(j, 2) = photo(j, 2)
         photo2(j, 3) = photo(j, 3)
         photo2(j, 4) = photo(j, 4)
         photo2(j, 5) = photo(j, 5)
Next j
For k = 1 To photopoints
photo2(k, 2) = photo2(k, 2) - 100
photo2(k, 3) = 100 - photo2(k, 3)
photo2(k, 4) = photo2(k, 2) - photo2(k, 4)
photo2(k, 5) = photo2(k, 3) - photo2(k, 5) + 10
Next k
For k = 1 To photopoints
photo2(k, 2) = photo2(k, 2) * 164 / 163.81
photo2(k, 3) = photo2(k, 3) * 163.99 / 163.74
photo2(k, 4) = photo2(k, 4) * 164 / 163.81
photo2(k, 5) = photo2(k, 5) * 163.99 / 163.74
Next k
Dim N As Integer
N = 0
For i = 1 To conpoints
   For j = 1 To photopoints
      If con(i, 1) = photo(j, 1) Then
         N = N + 1
         con1(N, 1) = con(i, 1)
         con1(N, 2) = con(i, 2)
         con1(N, 3) = con(i, 3)
         con1(N, 4) = con(i, 4)
         photo1(N, 1) = photo2(j, 1)
         photo1(N, 2) = photo2(j, 2)
         photo1(N, 3) = photo2(j, 3)
         photo1(N, 4) = photo2(j, 4)
         photo1(N, 5) = photo2(j, 5)
      End If
    Next j
Next i
Dim m As Double
For k = 1 To N
    m = con1(k, 3)
    con1(k, 3) = con1(k, 2)
    con1(k, 2) = m
Next k
Dim d1, d2, s As Double
d1 = Sqr((photo1(1, 2) - photo1(2, 2)) ^ 2 + (photo1(1, 3) - photo1(2, 3)) ^ 2)
d2 = Sqr((con1(1, 2) - con1(2, 2)) ^ 2 + (con1(1, 3) - con1(2, 3)) ^ 2 + (con1(1, 4) - con1(2, 4)) ^ 2)
s = d2 / d1 * 1000
Dim k01, k02, k03, m0, dx0, dy0, dz0 As Double
'7个绝对定向元素
dx0 = 0
dy0 = 0
dz0 = 0
m0 = 1
k01 = 0
k02 = 0
k03 = 0
Dim k10, k20, k30, bx, by, bz, u, v As Double
k10 = 0
k20 = 0
k30 = 0
bx = photo2(1, 2) - photo2(1, 4)
by = 0
bz = 0
Dim X(1 To 20), Y(1 To 20), Z(1 To 20) As Double
For k = 1 To photopoints
X(k) = photo2(k, 2)
Y(k) = photo2(k, 3)
Z(k) = -f
Next k
For Diedai = 1 To 10
Dim a10, a20, a30, b10, b20, b30, c10, c20, c30 As Double
a10 = Cos(k10) * Cos(k30) - Sin(k10) * Sin(k20) * Sin(k30)
a20 = -Cos(k10) * Sin(k30) - Sin(k10) * Sin(k20) * Cos(k30)
a30 = -Sin(k10) * Cos(k20)
b10 = Cos(k20) * Sin(k30)
b20 = Cos(k20) * Cos(k30)
b30 = -Sin(k20)
c10 = Sin(k10) * Cos(k30) + Cos(k10) * Sin(k20) * Sin(k30)
c20 = -Sin(k10) * Sin(k30) + Cos(k10) * Sin(k20) * Cos(k30)
c30 = Cos(k10) * Cos(k20)
by = bx * u
bz = bx * v
Dim X0(1 To 20), Y0(1 To 20), Z0(1 To 20) As Double
For k = 1 To photopoints
X0(k) = a10 * photo2(k, 4) + a20 * photo2(k, 5) + a30 * (-f)
Y0(k) = b10 * photo2(k, 4) + b20 * photo2(k, 5) + b30 * (-f)
Z0(k) = c10 * photo2(k, 4) + c20 * photo2(k, 5) + c30 * (-f)
Next k
Dim N1(1 To 20), N2(1 To 20) As Double
For k = 1 To photopoints
N1(k) = (bx * Z0(k) - bz * X0(k)) / (X(k) * Z0(k) - X0(k) * Z(k))
N2(k) = (bx * Z(k) - bz * X(k)) / (X(k) * Z0(k) - X0(k) * Z(k))
Next k
Dim L(1 To 20) As Double
For k = 1 To photopoints
L(k) = N1(k) * Y(k) - N2(k) * Y0(k) - by
Next k
Dim A(1 To 20, 1 To 5), B(1 To 5, 1 To 20), C(1 To 5, 1 To 5), D(1 To 5, 1 To 20), R(1 To 5) As Double
Dim E()
'B为A的转置矩阵  C为B*A E为C的逆矩阵 D为E*B R为结果矩阵
For k = 1 To photopoints
    A(k, 1) = bx
    A(k, 2) = -Y0(k) / Z0(k) * bx
    A(k, 3) = -X0(k) * Y0(k) / Z0(k) * N2(k)
    A(k, 4) = -(Z0(k) + Y0(k) ^ 2 / Z0(k)) * N2(k)
    A(k, 5) = X0(k) * N2(k)
Next k
For i = 1 To 5
    For j = 1 To photopoints
        B(i, j) = A(j, i)
    Next j
Next i
For i = 1 To 5
    For j = 1 To 5
        C(i, j) = 0
        For k = 1 To photopoints
            C(i, j) = C(i, j) + B(i, k) * A(k, j)
        Next k
    Next j
Next i
Call jzqn(C(), E())
For i = 1 To 5
    For j = 1 To photopoints
        D(i, j) = 0
        For k = 1 To 5
            D(i, j) = D(i, j) + E(i, k) * B(k, j)
        Next k
    Next j
Next i
For i = 1 To 5
    R(i) = 0
    For j = 1 To photopoints
        R(i) = R(i) + D(i, j) * L(j)
    Next j
Next i
u = u + R(1)
v = v + R(2)
k10 = k10 + R(3)
k20 = k20 + R(4)
k30 = k30 + R(5)
If Abs(R(1)) < 0.00003 And Abs(R(2)) < 0.00003 And Abs(R(3)) < 0.00003 And Abs(R(4)) < 0.00003 And Abs(R(5)) < 0.00003 Or Diedai > 10 Then
  Exit For
Else
  End If
Next Diedai
Dim x1(1 To 10), y1(1 To 10), z1(1 To 10), x2(1 To 10), y2(1 To 10), z2(1 To 10), N01(1 To 10), N02(1 To 10), xp(1 To 10), yp(1 To 10), zp(1 To 10), L0(1 To 30) As Double
by = bx * u
bz = bx * v
For i = 1 To N
x1(i) = photo1(i, 2) / 1000
y1(i) = photo1(i, 3) / 1000
z1(i) = -f / 1000
x2(i) = (a10 * photo1(i, 4) + a20 * photo1(i, 5) + a30 * (-f)) / 1000
y2(i) = (b10 * photo1(i, 4) + b20 * photo1(i, 5) + b30 * (-f)) / 1000
z2(i) = (c10 * photo1(i, 4) + c20 * photo1(i, 5) + c30 * (-f)) / 1000
N01(i) = (bx / 1000 * z2(i) - bz / 1000 * x2(i)) / (x1(i) * z2(i) - x2(i) * z1(i))
N02(i) = (bx / 1000 * z1(i) - bz / 1000 * x1(i)) / (x1(i) * z2(i) - x2(i) * z1(i))
xp(i) = s * N01(i) * x1(i)
yp(i) = 0.5 * (N01(i) * y1(i) + N02(i) * y2(i) + by / 1000) * s
zp(i) = s * f / 1000 + s * N01(i) * z1(i)
Next i
For Diedai = 1 To 30
Dim a01, a02, a03, b01, b02, b03, c01, c02, c03 As Double
a01 = Cos(k01) * Cos(k03) - Sin(k01) * Sin(k02) * Sin(k03)
a02 = -Cos(k01) * Sin(k03) - Sin(k01) * Sin(k02) * Cos(k03)
a03 = -Sin(k01) * Cos(k02)
b01 = Cos(k02) * Sin(k03)
b02 = Cos(k02) * Cos(k03)
b03 = -Sin(k02)
c01 = Sin(k01) * Cos(k03) + Cos(k01) * Sin(k02) * Sin(k03)
c02 = -Sin(k01) * Sin(k03) + Cos(k01) * Sin(k02) * Cos(k03)
c03 = Cos(k01) * Cos(k02)
For i = 1 To N
L0(3 * i - 2) = con1(i, 2) - m0 * (a01 * xp(i) + a02 * yp(i) + a03 * zp(i)) - dx0
L0(3 * i - 1) = con1(i, 3) - m0 * (b01 * xp(i) + b02 * yp(i) + b03 * zp(i)) - dy0
L0(3 * i) = con1(i, 4) - m0 * (c01 * xp(i) + c02 * yp(i) + c03 * zp(i)) - dz0
Next i
Dim A0(1 To 30, 1 To 7), B0(1 To 7, 1 To 30), C0(1 To 7, 1 To 7), D0(1 To 7, 1 To 30), R0(1 To 7) As Double
Dim E0()
For i = 1 To N
    A0(3 * i - 2, 1) = 1
    A0(3 * i - 2, 2) = 0
    A0(3 * i - 2, 3) = 0
    A0(3 * i - 2, 4) = xp(i)
    A0(3 * i - 2, 5) = -zp(i)
    A0(3 * i - 2, 6) = 0
    A0(3 * i - 2, 7) = -yp(i)
    A0(3 * i - 1, 1) = 0
    A0(3 * i - 1, 2) = 1
    A0(3 * i - 1, 3) = 0
    A0(3 * i - 1, 4) = yp(i)
    A0(3 * i - 1, 5) = 0
    A0(3 * i - 1, 6) = -zp(i)
    A0(3 * i - 1, 7) = xp(i)
    A0(3 * i, 1) = 0
    A0(3 * i, 2) = 0
    A0(3 * i, 3) = 1
    A0(3 * i, 4) = zp(i)
    A0(3 * i, 5) = xp(i)
    A0(3 * i, 6) = yp(i)
    A0(3 * i, 7) = 0
Next i
For i = 1 To 7
    For j = 1 To 3 * N
        B0(i, j) = A0(j, i)
    Next j
Next i
For i = 1 To 7
    For j = 1 To 7
        C0(i, j) = 0
        For k = 1 To 3 * N
            C0(i, j) = C0(i, j) + B0(i, k) * A0(k, j)
        Next k
    Next j
Next i
Call jzqn(C0(), E0())
For i = 1 To 7
    For j = 1 To 3 * N
        D0(i, j) = 0
        For k = 1 To 7
            D0(i, j) = D0(i, j) + E0(i, k) * B0(k, j)
        Next k
    Next j
Next i
For i = 1 To 7
    R0(i) = 0
    For j = 1 To 3 * N
        R0(i) = R0(i) + D0(i, j) * L0(j)
    Next j
Next i
dx0 = dx0 + R0(1)
dy0 = dy0 + R0(2)
dz0 = dz0 + R0(3)
m0 = m0 + R0(4)
k01 = k01 + R0(5)
k02 = k02 + R0(6)
k03 = k03 + R0(7)
If Abs(R0(5)) < 0.000003 And Abs(R0(6)) < 0.000003 And Abs(R0(7)) < 0.000003 Or Diedai > 30 Then
  Exit For
Else
  End If
Next Diedai
Dim xtp(1 To 10), ytp(1 To 10), ztp(1 To 10) As Double
For i = 1 To N
    xtp(i) = m0 * (a01 * xp(i) + a02 * yp(i) + a03 * zp(i)) + dx0
    ytp(i) = m0 * (b01 * xp(i) + b02 * yp(i) + b03 * zp(i)) + dy0
    ztp(i) = m0 * (c01 * xp(i) + c02 * yp(i) + c03 * zp(i)) + dz0
Next i